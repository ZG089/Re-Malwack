name: build

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build.yml'
      - 'module/**'
      - 'update.json'
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/build.yml'
      - 'module/**'
      - 'update.json'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set variables
        id: setup
        run: |
          COMMIT_NUM=$(git rev-list --count HEAD)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          VERSION=$(jq -r .version update.json)
          ZIP_NAME="Re-Malwack_${VERSION}-${COMMIT_NUM}-${COMMIT_HASH}"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: module/

      - name: Create ZIP
        run: |
          cd module
          zip -r "../$ZIP_NAME.zip" ./*
          cd ..

      - name: Check Commit Info
        id: check_commit
        run: |
          COMMIT_MSG='${{ github.event.head_commit.message }}'
          if echo "$COMMIT_MSG" | head -n1 | sed "s/'/\\\\'/g" | grep -qiE "release|version|readme|workflow|website|site"; then
            echo "SKIP=true" >> $GITHUB_ENV
          else
            echo "SKIP=false" >> $GITHUB_ENV
          fi

      - name: Send Release
        if: env.SKIP == 'false'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TUMBNAIL: "$GITHUB_WORKSPACE/assets/dl.jpg"
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          COMMIT_MSG="$(echo "${{ github.event.head_commit.message }}" | sed 's/[_*`\[\]()~>#+=|{}.!-]/\\&/g')"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          CAPTION="⚙️ *New test release!*%0ACommit: \`${COMMIT_MSG}\`%0A[View Commit](${COMMIT_URL})%0A[Workflow Run](${RUN_URL})"
          curl -sS "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
              -F chat_id="-1002271023118" \
              -F message_thread_id="1314" \
              -F document=@"${{ env.ZIP_NAME }}.zip" \
              -F thumb=@"${{ env.THUMBNAIL }}" \
              -F caption="$CAPTION" \
              -F parse_mode="MarkdownV2"
